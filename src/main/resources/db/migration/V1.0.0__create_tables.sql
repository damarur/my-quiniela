DROP TABLE IF EXISTS QUINIELA_GAMES CASCADE;
DROP TABLE IF EXISTS QUINIELA CASCADE;
DROP TABLE IF EXISTS TEAM CASCADE;

CREATE TABLE TEAM
(
    ID   INTEGER GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR(255) NOT NULL,
    PRIMARY KEY (ID)
);

CREATE TABLE QUINIELA
(
    ID          INTEGER GENERATED BY DEFAULT AS IDENTITY,
    DATE_TIME   TIMESTAMP(6) NOT NULL,
    TITLE       VARCHAR(255) NOT NULL,
    DESCRIPTION VARCHAR(255),
    PRIMARY KEY (ID)
);

CREATE TABLE QUINIELA_GAMES
(
    SEQUENCE_ORDER  INTEGER      NOT NULL,
    QUINIELA_ID     INTEGER      NOT NULL,
    DATE_TIME       TIMESTAMP(6),
    LOCAL_TEAM_ID   VARCHAR(255) NOT NULL,
    LOCAL_GOALS     INTEGER,
    VISITOR_TEAM_ID VARCHAR(255) NOT NULL,
    VISITOR_GOALS   INTEGER,
    COMPUTED_RESULT VARCHAR(1),
    PRIMARY KEY (QUINIELA_ID, SEQUENCE_ORDER)
);

CREATE TABLE USUARIO
(
    ID            INTEGER GENERATED BY DEFAULT AS IDENTITY,
    EMAIL         VARCHAR(255),
    PASSWORD_HASH VARCHAR(255),
    ACTIVE        BOOLEAN,
    LAST_LOGIN    TIMESTAMP(6) WITH TIME ZONE,
    CREATED_DATE  TIMESTAMP(6) WITH TIME ZONE,
    MODIFIED_DATE TIMESTAMP(6) WITH TIME ZONE,
    PRIMARY KEY (ID)
);

ALTER TABLE IF EXISTS QUINIELA_GAMES ADD CONSTRAINT LOCAL_TEAM_FK FOREIGN KEY (LOCAL_TEAM_ID) REFERENCES TEAM;
ALTER TABLE IF EXISTS QUINIELA_GAMES ADD CONSTRAINT VISITOR_TEAM_FK FOREIGN KEY (VISITOR_TEAM_ID) REFERENCES TEAM;
ALTER TABLE IF EXISTS QUINIELA_GAMES ADD CONSTRAINT QUINIELA_FK FOREIGN KEY (QUINIELA_ID) REFERENCES QUINIELA;

CREATE TABLE PENYA
(
    ID          INTEGER GENERATED BY DEFAULT AS IDENTITY,
    NAME        VARCHAR(255) NOT NULL,
    DESCRIPTION VARCHAR(255),
    DOUBLES     INTEGER,
    TRIPLES     INTEGER,
    PRIMARY KEY (ID)
);

CREATE TABLE PENYA_ADMINS
(
    PENYA_ID INTEGER NOT NULL,
    USER_ID  INTEGER NOT NULL,
    PRIMARY KEY (PENYA_ID, USER_ID)
);

ALTER TABLE IF EXISTS PENYA_ADMINS ADD CONSTRAINT PENYA_ADMINS_PENYA_FK FOREIGN KEY (PENYA_ID) REFERENCES PENYA;
ALTER TABLE IF EXISTS PENYA_ADMINS ADD CONSTRAINT PENYA_ADMINS_USER_FK FOREIGN KEY (USER_ID) REFERENCES USUARIO;

CREATE TABLE PENYA_USERS
(
    PENYA_ID INTEGER NOT NULL,
    USER_ID  INTEGER NOT NULL,
    PRIMARY KEY (PENYA_ID, USER_ID)
);

CREATE TABLE PENYA_QUINIELA
(
    PENYA_ID    INTEGER NOT NULL,
    QUINIELA_ID INTEGER NOT NULL,
    DOUBLES     INTEGER,
    TRIPLES     INTEGER,
    HITS        INTEGER,
    RESULT      FLOAT,
    PRIMARY KEY (PENYA_ID, QUINIELA_ID)
);

ALTER TABLE IF EXISTS PENYA_USERS ADD CONSTRAINT PENYA_USERS_PENYA_FK FOREIGN KEY (PENYA_ID) REFERENCES PENYA;
ALTER TABLE IF EXISTS PENYA_USERS ADD CONSTRAINT PENYA_USERS_USER_FK FOREIGN KEY (USER_ID) REFERENCES USUARIO;

COMMIT;